#!/usr/bin/env bash
#
# Build tests for AVR ATmega1280
#

# exit on first failure
set -e

#
# Build with the default configurations
#
#restore_configs
#exec_test $1 $2 "Default Configuration" "$3"

#
# Test MESH_BED_LEVELING, Closed-loop, Power Monitor, Ultimaker LCD
#
restore_configs
opt_set LCD_LANGUAGE an \
        POWER_MONITOR_CURRENT_PIN 14 POWER_MONITOR_VOLTAGE_PIN 15 \
        CLOSED_LOOP_ENABLE_PIN 44 CLOSED_LOOP_MOVE_COMPLETE_PIN 45
opt_enable ULTIMAKERCONTROLLER \
           EEPROM_SETTINGS EEPROM_BOOT_SILENT EEPROM_AUTO_INIT \
           SENSORLESS_BACKOFF_MM HOMING_BACKOFF_POST_MM HOME_Y_BEFORE_X CODEPENDENT_XY_HOMING \
           MESH_BED_LEVELING ENABLE_LEVELING_FADE_HEIGHT MESH_G28_REST_ORIGIN LCD_BED_LEVELING MESH_EDIT_MENU \
           G26_MESH_VALIDATION GCODE_QUOTED_STRINGS \
           EXTERNAL_CLOSED_LOOP_CONTROLLER POWER_MONITOR_CURRENT POWER_MONITOR_VOLTAGE
exec_test $1 $2 "MESH_BED_LEVELING, Closed-loop, Power Monitor, Ultimaker LCD" "$3"

#
# Test SPINDLE_FEATURE with zero extruders
#
restore_configs
opt_set MOTHERBOARD BOARD_RIGIDBOARD EXTRUDERS 0 LCD_LANGUAGE hu \
        AXIS_RELATIVE_MODES '{ true, true, true }' \
        DEFAULT_AXIS_STEPS_PER_UNIT '{ 80, 80, 400 }' \
        DEFAULT_MAX_FEEDRATE '{ 300, 300, 5 }' \
        DEFAULT_MAX_ACCELERATION '{ 3000, 3000, 100 }' \
        MANUAL_FEEDRATE '{ 50*60, 50*60, 4*60 }'
opt_enable SPINDLE_FEATURE SPINDLE_CHANGE_DIR RIGIDBOT_PANEL EEPROM_SETTINGS \
           HOMING_BACKOFF_POST_MM HOME_Y_BEFORE_X HOME_Y_BEFORE_X
opt_disable EEPROM_BOOT_SILENT EEPROM_AUTO_INIT FASTER_GCODE_PARSER
exec_test $1 $2 "Spindle, Zero Extruders, Rigidbot Panel" "$3"

#
# ...and without PWM
#
opt_disable SPINDLE_LASER_USE_PWM
exec_test $1 $2 "(No PWM)" "$3"

#
# Test DUAL_X_CARRIAGE
#
restore_configs
opt_set MOTHERBOARD BOARD_ZRIB_V52 \
        LCD_LANGUAGE pt REPRAPWORLD_KEYPAD_MOVE_STEP 10.0 \
        EXTRUDERS 2 TEMP_SENSOR_1 1
opt_enable USE_XMAX_PLUG DUAL_X_CARRIAGE REPRAPWORLD_KEYPAD
exec_test $1 $2 "ZRIB_V52 | DUAL_X_CARRIAGE" "$3"

#
# Delta Config (generic) + Probeless
#
use_example_configs delta/generic
opt_enable REPRAP_DISCOUNT_SMART_CONTROLLER DELTA_AUTO_CALIBRATION DELTA_CALIBRATION_MENU
exec_test $1 $2 "RAMPS | DELTA | RRD LCD | DELTA_AUTO_CALIBRATION | DELTA_CALIBRATION_MENU" "$3"

#
# Delta Config (generic) + ABL bilinear + BLTOUCH
#
use_example_configs delta/generic
opt_set LCD_LANGUAGE cz \
        Z_MIN_PROBE_ENDSTOP_INVERTING false \
        Z_MIN_ENDSTOP_INVERTING false
opt_enable REPRAP_DISCOUNT_SMART_CONTROLLER DELTA_CALIBRATION_MENU AUTO_BED_LEVELING_BILINEAR BLTOUCH
exec_test $1 $2 "DELTA | RRD LCD | ABL Bilinear | BLTOUCH" "$3"

# clean up
restore_configs
