#!/usr/bin/env bash
#
# build_example
#
# Usage: build_example internal config-home config-folder
#

# Require 'internal' as the first argument
[[ "$1" == "internal" ]] || { echo "Don't call this script directly, use build_all_examples instead." ; exit 1 ; }

echo "Testing $3:"

shopt -s nullglob
for sub in $2/config/examples/$3/*/; do
  [[ -d $sub ]] || continue
  base=`basename "$sub"`

  if [[ ! -f $sub/Configuration.h ]] && [[ ! -f $sub/Configuration_adv.h ]]; then
    echo "No configuration files found in $sub"
    continue
  fi

  echo "Getting configuration files from $sub"
  cp "$2/config/default"/*.h    Marlin/
  cp "$sub"/Configuration.h     Marlin/ 2>/dev/null
  cp "$sub"/Configuration_adv.h Marlin/ 2>/dev/null
  cp "$sub"/_Bootscreen.h       Marlin/ 2>/dev/null
  cp "$sub"/_Statusscreen.h     Marlin/ 2>/dev/null

  echo "Building the firmware now..."
  ./mftest -a || { echo "Failed"; exit 1; }
done

echo "Success"
